## Проверка прав доступа на стороне сервера IASUFR

### 1. Введение
**Каждый** запрос с клиента (javascript) на сервер должен проверяться на права доступа на стороне сервера.
Запросы на сервер выполняются с помощью вызова `iasufr.ajax`, пример:
```javascript
iasufr.ajax({
    url: "frm.MyClass.cls",
    data: { func: "DoSomething", param: 'test' },
    success: function() {
        iasufr.alert("Test done!");
    }
});
```
Данный запрос вызывает метод `DoSomething` из класса `MyClass`. Серверный код выглядит следующим образом:
```
ClassMethod DoSomethingWS()
{
    $$$fromJSON(%request.Get("json", ""), .o)		
	if (o = "") $$$qErr("Не вказан json")
	if (o.param = "") $$$qErr("Не вказан param")
	
	s json = "{ ""param"": """ _ param _ """}"
	$$$wOkJson(json)
}
```
Серверные методы, которые вызываются из javascript, всегда должны оканчиваться на `WS`.
Данный метод проверяет, пришли ли параметры и задан ли параметр `param` и возвращает параметр обратно клиенту.
В данном методе не реализована проерка прав доступа.

### 2. Проверка прав доступа на сервере

#### 2.1 Получение текущего пользователя и его организации
Чтобы получить текущего залогиненого пользователя, необходимо использовать макрос `$$$usr`:
```
s idUser = $G(^Usr("IL", $$$usr))
```
Далее, имея `idUser`, можно осуществлять проверку на права доступа. Проверка доступа по клобали `MyGlobal`:
```
s idUser = $G(^Usr("IL", $$$usr))
if ($G(^MyGlobal("U", idUser) = "")) $$$qErr("Нама прав")
```
Также можно получить логин пользователя и делать проверку по нему, если в этом есть необходимость:
```
s login = $$$usr
if ($G(^MyGlobal("L", login) = "")) $$$qErr("Нама прав")
```
Данные примеры имеют общий характер, в реальном приложении структура глобали и проверка будет более сложными.


Чтобы получить организацию текущего пользователя, можно использовать метод `GetCurrenUserOrgId`:
```
s curIdOrg = ##class(ac.Usr).GetCurrenUserOrgId()
```

#### 2.2. Проверка на принадлежность организации
Для проверки имеет ли пользователь доступ к организации на дату используется следующий код: 
```
if (##class(ac.Usr).CheckOrgAccess(idOrg, date) = 0) $$$qErr("Нама прав")
```

#### 2.3. Проверка доступа к справочнику
```
    if ('##class(ac.Perm).CheckSprav($$$usr, sprav)) $$$qErr("Нама прав")	
```
Переменная `sprav` - это текстовый ключ справочника.

#### 2.4. Проверка доступа к пункту меню
```
    if ('##class(ac.Perm).CheckMenu($$$usr, menuId, isINum, isNotMenu)) $$$qErr("Нама прав")
```

#### 2.5. Проверка доступа к функции
```
if ('##class(ac.Perm).CheckFunc($$$usr, funcName)) $$$qErr("Нама прав")
```

#### 2.6. Проверка принадлежности к группе
```
if ('##class(ac.Perm).CheckGroup($$$usr, groupId)) $$$qErr("Нама прав")
```

#### 3. Макросы для проверки доступа
Можно использовать более короткую запись для проверки доступа к группе или функции используя макросы `$$$pGrp` и `$$$pFunc`:
```
if ('$$$pGrp(1)) $$$qErr("Нама прав")
if ('$$$pFunc(2)) $$$qErr("Нама прав")
```
Данные пример проверяет принадлежность пользователя к группе с `idGroup=1` и к функции с `idFunc=2`.

### 4. Финальный пример кода с проверками:
```
ClassMethod DoSomethingWS()
{
    $$$fromJSON(%request.Get("json", ""), .o)		
    if (o = "") $$$qErr("Не вказан json")
    if (o.param = "") $$$qErr("Не вказан param")
    if (o.idOrg = "") $$$qErr("Не вказан idOrg")
    if (o.date = "") $$$qErr("Не вказан date")
    
    // Проверка на группу
    if ('$$$pGrp(1)) $$$qErr("Нама прав")
    
    // Проверка на функцию
    if ('$$$pFunc(2)) $$$qErr("Нама прав")
    
    // Проверка на организацию
    if (##class(ac.Usr).CheckOrgAccess(o.idOrg, o.date) = 0) $$$qErr("Нама прав") 
    
    // Проверка на свою глобаль с дополнительными настроками прав
    s data = $G(^Access("U", $$$usr))
    if ('$p(data, $$$sep, 4))  $$$qErr("Нама прав")   
    
    s json = "{ ""param"": """ _ param _ """}"
    $$$wOkJson(json)
}
```
